---
layout: post
title: Java规范
categories: Java
description: 阿里Java规范总结
keywords: 其他
---

上个月因为NPE错误，导致线上某个流程卡住进行不下去，被领导们批斗了一番。最后让我将功补过，于4月初分享《阿里巴巴Java开发手册》心得。
于是最近我结合着《Clean Code》(《代码整洁之道》)来研究阿里推出的规范，有些想法不吐不快。
 
# 英雄主义 -> 集体主义

  纵观人类的历史，工业革命出现前，个人武勇似乎还能在军队吃香。但在现代化的军队里，纪律大于一切。因为哪怕再厉害的一群人，没有令行禁止的规范，也无法成为强军。
  码农也是如此，在十年前的时候还是"各凭本事不报错，人走懵逼得重构"的年代。每个人都有自己的书写习惯，光命名习惯这一点，驼峰党、下划线党、首字母缩写党、拼音党就群雄并起，不相示弱。
  终于在大约2、3年前，行业里有了"潜规则"，比如java方法必须 lowerCamelCase 风格，但很多人还不知道，终于今年年初阿里出了套《阿里巴巴Java开发手册》，这里我就挑一些新人容易犯错的地方讲一下。
  
  1. **类名**使用 UpperCamelCase 风格，必须遵从驼峰形式，但以下情形例外：（领域模型的相关命名）DO / BO / DTO / VO 等。
  
        > 正例： MarcoPolo / UserDO / XmlService / TcpUdpDeal / TaPromotion
        
  2. **方法名、参数名、成员变量、局部变量**都统一使用 lowerCamelCase 风格，必须遵从
      驼峰形式。   
      
        > 正例： localValue / getHttpMessage() / inputUserId
        
  3. **常量**命名全部大写，单词间用下划线隔开，力求语义表达完整清楚，不要嫌名字长。
  
        > 正例： MAX_STOCK_COUNT
          反例： MAX_COUNT
          
  4. **Service/DAO** 层方法命名规约
		* 获取单个对象的方法用 get 做前缀。
		* 获取多个对象的方法用 list 做前缀。
		* 获取统计值的方法用 count 做前缀。
		* 插入的方法用 save（推荐）或 insert 做前缀。
		* 删除的方法用 remove（推荐）或 delete 做前缀。
		* 修改的方法用 update 做前缀。
		
  5. **POJO**（Plain Ordinary Java Object) 
		* 数据对象：xxxDO，xxx 即为数据表名。
		* 数据传输对象：xxxDTO，xxx 为业务领域相关的名称。
		* 展示对象：xxxVO，xxx 一般为网页名称。
		* POJO 是 DO/DTO/BO/VO 的统称，禁止命名成 xxxPOJO。
		
  6. **枚举** 用Enum结尾,枚举成员名称需要全大写，单词间用下划线隔开。
  
        > 正例：枚举名字：DealStatusEnum，成员名称：SUCCESS / UNKOWN_REASON。
        
  7. 杜绝完全不规范的缩写，避免望文不知义。
  
        > 反例： AbstractClass “缩写”命名成 AbsClass;
              condition“缩写”命名成 condi
        此类随意缩写严重降低了代码的可阅读性。
    
  8. **格式** 我对照过Intellij Idea默认的格式和《阿里巴巴Java开发手册》规定的格式，两者是一样的。
	所以Java文件习惯性使用Command + Alt + L 格式化即可。这里就不多讲了。

# 代码三境界

  > 宋代靖居和尚提出参禅的三重境界是：第一重境界是“看山是山，看水是水”；第一重境界是“看山不是山，看水不是水”；第一重境界是“看山还是山，看水还是水”。
    
  我认为代码也有三重境界：
    
    - 不写注释
    - 写注释
    - 不须写注释
    
  不写注释 -> 写注释 很好理解，毕竟注释能快速理解别人一大段复杂代码的含义。在《阿里巴巴Java开发手册》中也提到一些日志的规范。比如：
  
  1. 类、类属性、类方法的注释必须使用 Javadoc 规范，使用/** 内容 */格式，不得使用
  //xxx 方式。
  说明：在 IDE 编辑窗口中，Javadoc 方式会提示相关注释，生成 Javadoc 可以正确输出相应注
  释；在 IDE 中，工程调用方法时，不进入方法即可悬浮提示方法、参数、返回值的意义，提高
  阅读效率。
  
  2. 所有的抽象方法（包括接口中的方法）必须要用 Javadoc 注释、除了返回值、参数、
  异常说明外，还必须指出该方法做什么事情，实现什么功能。
  说明：对子类的实现要求，或者调用注意事项，请一并说明。
  
  3. 所有的类都必须添加创建者信息。
  关于这点，其实我是不认同的。这一条的本意应该是如果出现bug或者有疑惑能尽快联系写这个方法的人，但一个类经常经过多个人编写，今天你加一个方法，明天我改一个方法的。
  很多时候类的创建者都不知道这个类里被别人加了这个方法。所以如果想找到方法的所有者请通过编辑器的Annotate。
  
  4. 注释掉的代码尽量要配合说明，而不是简单的注释掉。
     说明：代码被注释掉有两种可能性：1）后续会恢复此段代码逻辑。2）永久不用。前者如果没
     有备注信息，难以知晓注释动机。后者建议直接删掉（代码仓库保存了历史代码）。
     
  5. 特殊注释标记，请注明标记人与标记时间。注意及时处理这些标记，通过标记扫描，
     经常清理此类标记。线上故障有时候就是来源于这些标记处的代码。
     
     - 待办事宜（TODO）:（ 标记人，标记时间，[预计处理时间]）
     表示需要实现，但目前还未实现的功能。这实际上是一个 Javadoc 的标签，目前的 Javadoc
     还没有实现，但已经被广泛使用。只能应用于类，接口和方法（因为它是一个 Javadoc 标签）。
     - 错误，不能工作（FIXME）:（标记人，标记时间，[预计处理时间]）
     在注释中用 FIXME 标记某代码是错误的，而且不能工作，需要及时纠正的情况。
  
  那 写注释 -> 不须写注释 又是什么意思呢？ 
    
  > 好的命名、代码结构是自解释的，注释力求精简准确、表达到位。避免出现注释的
    一个极端：过多过滥的注释，代码的逻辑一旦修改，修改注释是相当大的负担。
    
  比如你要在添加车辆时写一个很麻烦的正则验证方法，光从字面上很难看出判断的是什么，这时候完全可以用 Ctrl+Alt+m 抽取方法。并在方法名里表达出这个方法的作用。
  这样别人读你的代码时就不需要看注释了。
  
# 防患于未然

  大家都知道治病的成本肯定高于打疫苗，代码也是这样，如果等出现错误再改，肯定比出错之前就改。
    
  - NPE （Null Point Exception，空指针异常）
  新人最容易犯的错，调用任何参数时都要注意这个参数是否可能为空。
  
      * 链式调用。比如.equals，.getXXX等，应使用常量或确定有值的对象来调用 equals。
      
      * 比较大小。
  
  - equals 不等于 == . 
  
  很多人都犯过拿 == 比较long、比较string、比较list的低级错误。
  
  > 对于 Integer var=?在-128 至 127 之间的赋值，Integer 对象是在
    IntegerCache.cache 产生，会复用已有对象，这个区间内的 Integer 值可以直接使用==进行
    判断，但是这个区间之外的所有数据，都会在堆上产生，并不会复用已有对象，这是一个大坑，
    推荐使用 equals 方法进行判断。
    
  对于已经确认值在 -128 至 127 之间的数字可以采用 == 比较；
    
  ```
  a == b
  ```
    
  对Integer或Long采用 .longValue() 判断 == 的方法比较(当然a与b都要判空)。比如：
    
  ```
  a.longValue() == b.longValue()
  ```
    
  当然最好使用equals(a需要判空)：
    
  ```
  a.equals(b)
  ```
    
  或者 Objects.equals,不需要a和b判空了
  
  ```
  Objects.equals(a,b)
  ```
    

# 快速排查问题的好助手——日志

  1. 异常日志

  对大段代码进行 try-catch，这是不负责任的表现。catch 时请分清稳定代码和非稳
  定代码，稳定代码指的是无论如何不会出错的代码。对于非稳定代码的 catch 尽可能进行区分
  异常类型，再做对应的异常处理。
  
  有 try 块放到了事务代码中，catch 异常后，如果需要回滚事务，一定要注意手动回
  滚事务。
  
  > 这里我推荐下 @transactional 注解，可以回滚整个service
  
  2. 人为日志
  
  谨慎地记录日志。生产环境禁止输出 debug 日志；有选择地输出 info 日志；如果使
  用 warn 来记录刚上线时的业务行为信息，一定要注意日志输出量的问题，避免把服务器磁盘
  撑爆，并记得及时删除这些观察日志。
  说明：大量地输出无效日志，不利于系统性能提升，也不利于快速定位错误点。记录日志时请
  思考：这些日志真的有人看吗？看到这条日志你能做什么？能不能给问题排查带来好处？
        
    
# MySql需要注意的地方

  表必备三字段：id, gmt_create, gmt_modified。
  说明：其中 id 必为主键，类型为 unsigned bigint、单表时自增、步长为 1。gmt_create,
  gmt_modified 的类型均为 date_time 类型。
  
  > 在我们公司的新表，id改为表名+id，比如仓储车辆表的id wms_car_id
  
  小数类型为 decimal，禁止使用 float 和 double。
  说明：float 和 double 在存储的时候，存在精度损失的问题，很可能在值的比较时，得到不
  正确的结果。如果存储的数据范围超过 decimal 的范围，建议将数据拆成整数和小数分开存储。
  
  > 在我们公司，钱使用long存，单位为分。
  
  字段允许适当冗余，以提高性能，但是必须考虑数据同步的情况。冗余字段应遵循：
  1）不是频繁修改的字段。
  2）不是 varchar 超长字段，更不能是 text 字段。
  
  > 我们现在查询都是单表查询，更需要做冗余。

# 最后

因为时间关系，我这里不能把所有手册上的规范都讲一遍，希望大家还是要读一遍《阿里巴巴Java开发手册》，并根据自身实际情况来使用。